<%- include('../partials/header') %>

<div class="container mt-5">
  <h2 class="text-primary mb-4">Register a New Officer or Department Head</h2>

  <% if (success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= success %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% } %>
  <% if (error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= error %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% } %>

  <form method="POST" action="/admin/add-user" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label">Full Name</label>
      <input type="text" name="full_name" class="form-control" placeholder="Enter full name" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Email</label>
      <input type="email" name="email" class="form-control" placeholder="Enter email address" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Password</label>
      <input type="password" name="password" class="form-control" placeholder="Enter password" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Department</label>
      <input type="text" id="deptInput" class="form-control" placeholder="Type or select department" autocomplete="off" required>
      <input type="hidden" name="department_id" id="department_id">
      <ul class="list-group position-absolute w-100 d-none" id="deptDropdown" style="z-index: 1000;"></ul>
      <div class="form-text">Start typing to filter departments or select from the list.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Position</label>
      <select name="role" class="form-control" required>
        <option value="">Select the position</option>
        <option value="OFFICER">Officer</option>
        <option value="DEPT_HEAD">Department Head</option>
      </select>
    </div>

    <div class="d-grid">
      <button type="submit" class="btn btn-primary btn-lg">Add the officer/ Dept Head</button>
    </div>
  </form>

  <a href="/admin" class="btn btn-secondary mt-3">Back to Dashboard</a>
</div>

<script>
  // Departments array
  const depts = [
  <% depts.forEach((d, index) => { %>
    { id: "<%= d.id %>", name: "<%= d.name %>" }<%= index !== depts.length - 1 ? ',' : '' %>
  <% }); %>
  ];

  const input = document.getElementById('deptInput');
  const hiddenInput = document.getElementById('department_id');
  const dropdown = document.getElementById('deptDropdown');

  input.addEventListener('input', () => {
    hiddenInput.value = ''; // Clear hidden input while typing
    const val = input.value.toLowerCase();
    dropdown.innerHTML = '';
    const matches = depts.filter(d => d.name.toLowerCase().includes(val));
    if (matches.length === 0) {
      dropdown.classList.add('d-none');
      return;
    }

    matches.forEach(d => {
      const li = document.createElement('li');
      li.textContent = d.name;
      li.classList.add('list-group-item', 'list-group-item-action');
      li.style.cursor = 'pointer';
      li.addEventListener('click', () => {
        input.value = d.name;
        hiddenInput.value = d.id;
        dropdown.classList.add('d-none');
      });
      dropdown.appendChild(li);
    });

    dropdown.classList.remove('d-none');
  });

  // Hide dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('d-none');
    }
  });

  // Set hidden input if exact match on blur
  input.addEventListener('blur', () => {
    const match = depts.find(d => d.name.toLowerCase() === input.value.toLowerCase());
    hiddenInput.value = match ? match.id : '';
  });
</script>

<%- include('../partials/footer') %>
